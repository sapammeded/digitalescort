<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Naviguard — Escort (Detailed Scene Describer)</title>
<meta name="description" content="Digital Escort — detailed scene description, object attributes, risk scoring, OCR on-demand (single-file PWA)"/>
<meta name="theme-color" content="#0f172a">
<style>
:root{--bg:#0b1220;--surface:#0f172a;--text:#e6eef8;--muted:#9fb0c8;--accent:#0ea5e9;--danger:#ef4444;--ok:#10b981;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
.app{height:100vh;display:flex;flex-direction:column;position:relative;overflow:hidden;}
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(2,6,23,0.6);backdrop-filter:blur(6px);z-index:1200}
.title{display:flex;gap:10px;align-items:center;font-weight:700}
.small{font-size:13px;color:var(--muted)}
.main{flex:1;position:relative}
.camera{position:relative;height:100%;background:#000}
video#video{width:100%;height:100%;object-fit:cover}
canvas#overlay{position:absolute;inset:0;pointer-events:none;z-index:12}
.controls{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:10px;z-index:30}
.btn{background:rgba(255,255,255,0.06);color:var(--text);padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
.btn.primary{background:var(--accent)}
.btn.warn{background:var(--danger)}
.panel{position:absolute;right:12px;top:72px;width:360px;max-height:66vh;overflow:auto;background:linear-gradient(180deg, rgba(2,6,23,0.9), rgba(3,7,25,0.85));backdrop-filter:blur(6px);padding:10px;border-radius:12px;z-index:1400;border:1px solid rgba(255,255,255,0.04)}
.panel h3{margin:0 0 8px 0}
.row{display:flex;justify-content:space-between;align-items:center}
.badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.04);font-size:13px}
.object-item{padding:8px;border-radius:10px;margin-bottom:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
.kv{font-size:13px;color:var(--muted)}
.captionBar{position:absolute;left:50%;transform:translateX(-50%);bottom:78px;background:rgba(0,0,0,0.6);padding:10px 12px;border-radius:12px;z-index:2000;max-width:92%;text-align:center}
.riskLow{background:#0ea5a0;padding:6px 8px;border-radius:8px;color:#fff}
.riskMed{background:#f59e0b;padding:6px 8px;border-radius:8px;color:#fff}
.riskHigh{background:#ef4444;padding:6px 8px;border-radius:8px;color:#fff}
.topbarleft{display:flex;gap:8px;align-items:center}
.toggle{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;cursor:pointer}
.footer-note{position:absolute;left:12px;bottom:12px;z-index:2000;background:rgba(0,0,0,0.5);padding:6px 8px;border-radius:8px;color:var(--muted);font-size:12px}
/* responsive */
@media(max-width:600px){ .panel{width:92vw;right:6px;left:6px;top:auto;bottom:96px;max-height:40vh} .controls{bottom:22px} .captionBar{bottom:110px} }
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="topbarleft">
        <div class="title">🧭 Naviguard — Escort</div>
        <div class="small" id="gpsStatus">📍 GPS: -</div>
        <div class="small" id="conn">🌐 Offline</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="toggle" id="assistToggle">Assist: OFF</button>
        <button class="toggle" id="detailToggle">Detail: SIMPLE</button>
      </div>
    </div>

    <div class="main">
      <div class="camera">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>

        <div class="captionBar" id="captionBar" style="display:none">
          <div id="captionText" style="font-weight:700"></div>
          <div id="captionSub" class="small"></div>
        </div>

        <div class="controls" id="controls">
          <button class="btn" id="btnTake">📸 Capture</button>
          <button class="btn primary" id="btnPanic">⚠ PANIC</button>
          <button class="btn" id="btnToggleCam">🔄</button>
        </div>

        <div class="footer-note">Assist will describe everything in view. Use Detail toggle to see full attributes.</div>
      </div>
    </div>

    <div class="panel" id="descPanel">
      <h3>Scene Description</h3>
      <div class="row" style="margin-bottom:8px">
        <div class="small" id="sceneSummary">No assist running</div>
        <div><span id="riskBadge" class="badge">Risk: -</span></div>
      </div>

      <div id="envBlock" style="margin-bottom:8px">
        <div class="kv">Lighting: <span id="lighting">-</span></div>
        <div class="kv">Surface: <span id="surface">-</span></div>
        <div class="kv">People: <span id="peopleCount">0</span> • Vehicles: <span id="vehicleCount">0</span> • Bags: <span id="bagCount">0</span></div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="btnExportJSON">Export JSON</button>
        <button class="btn" id="btnClearInc">Clear Log</button>
      </div>

      <div id="objectsList"></div>
      <div style="margin-top:8px" class="small">Tip: klik "Run OCR" pada item untuk mengekstrak teks dari area itu (jika ada).</div>
    </div>

  </div>

<script>
/* Single-file "everything in front" describer
   - Lazy-load coco-ssd for detection
   - Analyze at ~1 FPS when Assist ON
   - Build structured description per object + environment
   - Show single-line caption + detailed panel
   - OCR on-demand
*/

/* ---------- Utilities ---------- */
const $ = id => document.getElementById(id);
const showToast = (t, ms=3000)=>{ console.log('TOAST', t); /* minimal */ };

/* ---------- State ---------- */
const state = {
  stream: null,
  lastPos: null,
  assist: false,
  detailFull: false,
  model: null,
  analyzing: false,
  lastAnalysis: null,
  assistLoop: null,
  tesseract: null,
  incidentLog: []
};

/* ---------- Camera & overlay ---------- */
const video = $('video'), overlay = $('overlay'), ctx = overlay.getContext('2d');
function resizeCanvas(){ overlay.width = overlay.offsetWidth; overlay.height = overlay.offsetHeight; }
window.addEventListener('resize', resizeCanvas);

/* start camera */
async function startCamera(facing='environment'){
  try{
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error('Camera not available');
    stopCamera();
    const c = { video: { facingMode: facing, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false };
    state.stream = await navigator.mediaDevices.getUserMedia(c);
    video.srcObject = state.stream;
    await new Promise(r=>video.onloadedmetadata = r);
    resizeCanvas();
  }catch(e){ console.error('startCamera', e); alert('Gagal akses kamera: '+e.message); }
}
function stopCamera(){ if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); state.stream=null; video.srcObject=null; } }

/* switch camera */
$('btnToggleCam').addEventListener('click', async ()=>{ try{ const facing = (state.usingFront ? 'environment':'user'); await startCamera(facing); state.usingFront = !state.usingFront; }catch(e){console.warn(e);} });

/* ---------- GPS (minimal) ---------- */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{ state.lastPos = p; $('gpsStatus').textContent = `📍 GPS: ${p.coords.accuracy.toFixed(0)}m`; }, ()=>{});
  navigator.geolocation.watchPosition(p=>{ state.lastPos = p; $('gpsStatus').textContent = `📍 GPS: ${p.coords.accuracy.toFixed(0)}m`; }, ()=>{});
}

/* ---------- Lazy-load detection model ---------- */
const TFJS = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js';
const COCO = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js';
function loadScript(src){ return new Promise((res,rej)=>{ if(document.querySelector('script[src="'+src+'"]')) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=()=>rej(new Error('fail load '+src)); document.head.appendChild(s); }); }
async function ensureModel(){
  if(state.model) return state.model;
  await loadScript(TFJS);
  await loadScript(COCO);
  state.model = await cocoSsd.load();
  return state.model;
}

/* ---------- Analyze frame (1 FPS) ---------- */
async function analyzeFrame(){
  if(!video || video.readyState < 2) return null;
  // downscale frame for speed
  const W = 320;
  const H = Math.round((video.videoHeight/video.videoWidth)*W) || 180;
  const c = document.createElement('canvas'); c.width = W; c.height = H;
  const cc = c.getContext('2d'); cc.drawImage(video, 0, 0, W, H);
  // lighting estimate (mean brightness)
  const imgd = cc.getImageData(0,0,W,H); let sum=0;
  for(let i=0;i<imgd.data.length;i+=4) sum += (imgd.data[i]*0.299 + imgd.data[i+1]*0.587 + imgd.data[i+2]*0.114);
  const avg = sum / (W*H);
  const lighting = avg < 50 ? 'Very dim' : avg < 100 ? 'Dim' : avg < 160 ? 'Medium' : 'Bright';
  // basic surface guess by color variance (very rough)
  const colors = {r:0,g:0,b:0};
  for(let i=0;i<imgd.data.length;i+=80){ colors.r += imgd.data[i]; colors.g += imgd.data[i+1]; colors.b += imgd.data[i+2]; }
  const maxc = Math.max(colors.r, colors.g, colors.b);
  let surface = 'unknown';
  if(maxc === colors.g) surface = 'vegetation/grass'; else if(maxc === colors.r) surface = 'brick/earth/soil'; else surface = 'concrete/tiles/asphalt';
  // ensure model
  await ensureModel();
  const preds = await state.model.detect(c);
  // map preds to normalized fields
  const filtered = preds.filter(p=>p.score>0.35).map((p,idx)=>{
    const bbox = p.bbox; // [x,y,w,h] relative to small canvas
    const centerX = bbox[0] + bbox[2]/2; const centerY = bbox[1] + bbox[3]/2;
    // distance heuristic: inverse bbox height
    const approxDist = estimateDistanceByBBox(bbox[3], H); // meters
    return {
      id: 'o'+idx+'_'+Date.now(),
      class: p.class,
      score: Math.round(p.score*100)/100,
      bbox_small: {x: Math.round(bbox[0]), y: Math.round(bbox[1]), w: Math.round(bbox[2]), h: Math.round(bbox[3])},
      center_norm: {x: +(centerX/W).toFixed(2), y: +(centerY/H).toFixed(2)},
      distance_m: approxDist,
      lastSeen: Date.now()
    };
  });
  // counts
  const peopleCount = filtered.filter(x=>x.class==='person').length;
  const vehicleCount = filtered.filter(x=>['car','truck','bus','motorcycle','bicycle','motorbike','truck'].includes(x.class)).length;
  const bagCount = filtered.filter(x=>['backpack','handbag','suitcase'].includes(x.class)).length;
  // motion: compare with lastAnalysis (very simple bbox center delta)
  if(state.lastAnalysis && state.lastAnalysis.objects){
    filtered.forEach(o=>{
      const prev = state.lastAnalysis.objects.find(p=>p.class===o.class && Math.abs(p.center_norm.x - o.center_norm.x) < 0.15 && Math.abs(p.center_norm.y - o.center_norm.y) < 0.15);
      if(prev){
        const dx = (o.center_norm.x - prev.center_norm.x), dy = (o.center_norm.y - prev.center_norm.y);
        const dist = Math.sqrt(dx*dx + dy*dy);
        o.motion = dist > 0.02 ? ( (dx*dx+dy*dy)>0.0009 ? 'moving' : 'slight') : 'static';
        // approaching if center shifts significantly towards center
        o.trend = prev.center_norm.y - o.center_norm.y > 0.03 ? 'approaching' : (prev.center_norm.y - o.center_norm.y < -0.03 ? 'receding' : 'stable');
      } else { o.motion='unknown'; o.trend='unknown'; }
    });
  } else {
    filtered.forEach(o=>{ o.motion='unknown'; o.trend='unknown'; });
  }
  const analysis = {
    timestamp: Date.now(),
    lighting, surface,
    peopleCount, vehicleCount, bagCount,
    objects: filtered
  };
  state.lastAnalysis = analysis;
  return analysis;
}

/* ---------- Display / UI ---------- */
function clearOverlay(){ ctx.clearRect(0,0,overlay.width,overlay.height); }
function drawObjectsOnOverlay(analysis){
  clearOverlay();
  if(!analysis || !analysis.objects) return;
  // compute scaling from small canvas to overlay
  const smallW = 320;
  const smallH = Math.round((video.videoHeight/video.videoWidth)*smallW) || 180;
  const sx = overlay.width / smallW;
  const sy = overlay.height / smallH;
  analysis.objects.forEach(o=>{
    const x = o.bbox_small.x * sx, y = o.bbox_small.y * sy, w = o.bbox_small.w * sx, h = o.bbox_small.h * sy;
    ctx.strokeStyle = 'rgba(255,165,0,0.95)'; ctx.lineWidth = 3; ctx.strokeRect(x,y,w,h);
    ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(x, y-22, 120, 22);
    ctx.fillStyle = '#fff'; ctx.font='14px sans-serif'; ctx.fillText(`${o.class} ${Math.round(o.score*100)}% • ${o.distance_m}m`, x+6, y-6);
  });
}

/* generate single-sentence caption + risk */
function generateCaption(analysis){
  if(!analysis) return {caption:'No data', risk:0, label:'Low', recommendation:'No action'};
  const parts = [];
  if(analysis.peopleCount>0) parts.push(`${analysis.peopleCount} orang`);
  if(analysis.vehicleCount>0) parts.push(`${analysis.vehicleCount} kendaraan`);
  if(analysis.bagCount>0) parts.push(`${analysis.bagCount} barang/tas`);
  const env = `Permukaan: ${analysis.surface}; Pencahayaan: ${analysis.lighting}`;
  const objnote = parts.length ? parts.join(', ') : 'tidak ada objek signifikan';
  // risk heuristic
  let score = 5;
  if(analysis.peopleCount>6) score += 25;
  else if(analysis.peopleCount>2) score += 10;
  if(analysis.bagCount>0) score += 20;
  // approaching people increase risk
  if(analysis.objects.some(o=>o.trend==='approaching' && o.class==='person' && o.distance_m <= 6)) score += 25;
  const label = score>=75 ? 'Critical' : score>=50 ? 'High' : score>=25 ? 'Medium' : 'Low';
  const rec = label==='Low' ? 'Monitor area' : label==='Medium' ? 'Waspada — cek objek' : label==='High' ? 'Hindari dekat — panggil backup' : 'Segera evakuasi / panic';
  const caption = `${env}. Terlihat: ${objnote}. Risiko: ${label}.`;
  return {caption, risk:score, label, recommendation:rec};
}

/* render panel details */
function renderPanel(analysis){
  if(!analysis){
    $('sceneSummary').textContent = 'Assist OFF';
    $('objectsList').innerHTML = '<div class="small">Assist mode not running.</div>';
    $('captionBar').style.display = 'none';
    $('riskBadge').textContent = 'Risk: -';
    return;
  }
  $('sceneSummary').textContent = `Updated: ${new Date(analysis.timestamp).toLocaleTimeString()}`;
  $('lighting').textContent = analysis.lighting;
  $('surface').textContent = analysis.surface;
  $('peopleCount').textContent = analysis.peopleCount;
  $('vehicleCount').textContent = analysis.vehicleCount;
  $('bagCount').textContent = analysis.bagCount;
  // objects list
  const out = [];
  analysis.objects.forEach((o,idx)=>{
    const html = `<div class="object-item" data-id="${o.id}">
      <div style="display:flex;justify-content:space-between"><div style="font-weight:700">${o.class} • ${o.distance_m}m</div><div class="kv">${o.score}</div></div>
      <div class="kv">center: ${o.center_norm.x}, ${o.center_norm.y} • bbox: ${o.bbox_small.x},${o.bbox_small.y},${o.bbox_small.w},${o.bbox_small.h}</div>
      <div class="kv">motion: ${o.motion} • trend: ${o.trend}</div>
      <div style="margin-top:6px;display:flex;gap:8px">
        <button class="btn" onclick="runOCRForObject('${o.id}')">Run OCR</button>
        <button class="btn" onclick="markAsIncident('${o.id}')">Mark Incident</button>
        <button class="btn" onclick="zoomToObject('${idx}')">Zoom</button>
      </div>
    </div>`;
    out.push(html);
  });
  $('objectsList').innerHTML = out.join('') || '<div class="small">No objects detected</div>';
  // caption
  const res = generateCaption(analysis);
  $('captionText').textContent = res.caption;
  $('captionSub').textContent = res.recommendation;
  $('captionBar').style.display = 'block';
  // risk badge color
  const badge = $('riskBadge');
  badge.textContent = `Risk: ${res.label}`;
  badge.className = 'badge';
  if(res.label==='Low') badge.style.background = '#10b981';
  else if(res.label==='Medium') badge.style.background = '#f59e0b';
  else badge.style.background = '#ef4444';
  // draw overlay boxes if detail full or even simple
  drawObjectsOnOverlay(analysis);
}

/* ---------- Helpers ---------- */
function estimateDistanceByBBox(hpx, frameH){
  // naive: calibrate constant for better results
  const K = 14000; // tweakable
  const val = Math.max(4, hpx);
  const d = Math.round(K / val);
  return Math.min(Math.max(d, 0.5), 500);
}

/* ---------- Assist loop ---------- */
async function startAssist(){
  if(state.assist) return;
  state.assist = true; $('assistToggle').textContent = 'Assist: ON';
  // lazy load model here
  await ensureModel();
  state.assistLoop = setInterval(async ()=>{
    if(state.analyzing) return;
    state.analyzing = true;
    try{
      const analysis = await analyzeFrame();
      state.lastAnalysis = analysis;
      renderPanel(analysis);
      // speak if high risk
      const cap = generateCaption(analysis);
      if(cap.risk >= 50){ if(window.speechSynthesis){ const u = new SpeechSynthesisUtterance(`${cap.caption} ${cap.recommendation}`); u.lang='id-ID'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); } }
    }catch(e){ console.warn(e); }
    state.analyzing = false;
  }, 1100);
}

function stopAssist(){
  state.assist = false; $('assistToggle').textContent = 'Assist: OFF';
  if(state.assistLoop){ clearInterval(state.assistLoop); state.assistLoop = null; }
  renderPanel(null);
}

/* ---------- OCR on-demand (lazy) ---------- */
const TESS = 'https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js';
async function ensureTesseract(){
  if(state.tesseract) return state.tesseract;
  await loadScript(TESS);
  if(window.Tesseract && window.Tesseract.createWorker){
    state.tesseract = await Tesseract.createWorker({logger: m=>{ /*ignore*/ }});
    await state.tesseract.load(); try{ await state.tesseract.loadLanguage('eng+ind'); await state.tesseract.initialize('eng'); }catch(e){ await state.tesseract.initialize('eng'); }
    return state.tesseract;
  } else { throw new Error('tesseract not available'); }
}
async function runOCRForObject(objId){
  try{
    const analysis = state.lastAnalysis;
    if(!analysis) return alert('No analysis available');
    const obj = analysis.objects.find(o=>o.id===objId);
    if(!obj) return alert('Object not found');
    // crop region from current frame (use scaled coordinates)
    const smallW = 320; const smallH = Math.round((video.videoHeight/video.videoWidth)*smallW) || 180;
    const sx = Math.max(0, obj.bbox_small.x), sy = Math.max(0, obj.bbox_small.y);
    const sw = obj.bbox_small.w, sh = obj.bbox_small.h;
    // capture high-res crop from video
    const full = document.createElement('canvas'); full.width = video.videoWidth; full.height = video.videoHeight;
    full.getContext('2d').drawImage(video, 0, 0, full.width, full.height);
    // map small coords to full size
    const scaleX = full.width / smallW, scaleY = full.height / smallH;
    const cx = Math.round(sx * scaleX), cy = Math.round(sy * scaleY), cw = Math.round(sw * scaleX), ch = Math.round(sh * scaleY);
    const crop = document.createElement('canvas'); crop.width = cw; crop.height = ch;
    crop.getContext('2d').drawImage(full, cx, cy, cw, ch, 0, 0, cw, ch);
    // preprocess simple: grayscale & threshold
    const ctxc = crop.getContext('2d');
    const id = ctxc.getImageData(0,0,cw,ch);
    for(let i=0;i<id.data.length;i+=4){
      const r=id.data[i], g=id.data[i+1], b=id.data[i+2];
      const lum = 0.299*r+0.587*g+0.114*b;
      id.data[i]=id.data[i+1]=id.data[i+2]=lum;
    }
    ctxc.putImageData(id,0,0);
    // run OCR
    await ensureTesseract();
    showToast('Running OCR...');
    const res = await state.tesseract.recognize(crop);
    const text = (res && res.data && res.data.text) ? res.data.text.trim() : '';
    alert('OCR Result:\\n' + (text || '(no text)'));
  }catch(e){ console.warn(e); alert('OCR failed: ' + e.message); }
}

/* ---------- Incident marking & export ---------- */
function markAsIncident(objId){
  if(!state.lastAnalysis) return;
  const obj = state.lastAnalysis.objects.find(o=>o.id===objId);
  const record = { timestamp: Date.now(), analysis: state.lastAnalysis, flagged: obj ? { id: objId, class: obj.class } : null };
  state.incidentLog.push(record);
  alert('Incident flagged and saved locally');
}
$('btnExportJSON').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({incidents: state.incidentLog, lastAnalysis: state.lastAnalysis}, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='naviguard-analysis.json'; a.click(); URL.revokeObjectURL(url);
});
$('btnClearInc').addEventListener('click', ()=>{ if(confirm('Clear incident log?')){ state.incidentLog = []; alert('Cleared'); } });

/* ---------- zoom placeholder ---------- */
function zoomToObject(idx){ /* can implement by centering display or cropping preview - placeholder */ alert('Zoom to object #' + idx); }

/* ---------- UI wiring ---------- */
$('assistToggle').addEventListener('click', ()=>{ if(!state.assist) startAssist(); else stopAssist(); });
$('detailToggle').addEventListener('click', ()=>{ state.detailFull = !state.detailFull; $('detailToggle').textContent = state.detailFull ? 'Detail: FULL' : 'Detail: SIMPLE'; });
$('btnTake').addEventListener('click', async ()=>{
  // capture high-res snapshot and save lastAnalysis as metadata
  if(!video || video.readyState < 2) return alert('Camera not ready');
  const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight; c.getContext('2d').drawImage(video, 0, 0, c.width, c.height);
  const dataUrl = c.toDataURL('image/jpeg', 0.9);
  const meta = { time: new Date().toISOString(), gps: state.lastPos ? {lat: state.lastPos.coords.latitude, lon: state.lastPos.coords.longitude, acc: state.lastPos.coords.accuracy} : null, analysis: state.lastAnalysis };
  const rec = { id: 'cap'+Date.now(), dataUrl, meta };
  state.incidentLog.push(rec);
  // auto-download
  const blob = await (await fetch(dataUrl)).blob();
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `nav-photo-${Date.now()}.jpg`; a.click(); URL.revokeObjectURL(url);
  alert('Photo captured and saved locally. Use Export JSON to export analysis.');
});
$('btnPanic').addEventListener('click', async ()=>{
  // immediate snapshot + loud notify
  $('btnPanic').disabled = true; try{ await $('btnTake').click(); if(window.navigator.vibrate) navigator.vibrate([200,100,200]); if(window.speechSynthesis){ const u=new SpeechSynthesisUtterance('Panic triggered. Location recorded.'); u.lang='id-ID'; window.speechSynthesis.speak(u); } }catch(e){console.warn(e);} finally{ setTimeout(()=>$('btnPanic').disabled=false,1500); }
});

/* ---------- start camera on load ---------- */
window.addEventListener('load', async ()=>{ await startCamera('environment'); $('conn').textContent = navigator.onLine ? '🌐 Online' : '🌐 Offline'; renderPanel(null); });

/* expose helpers for console debugging */
window._nav = { state, analyzeFrame, startAssist, stopAssist, ensureModel, runOCRForObject };
</script>
</body>
</html>